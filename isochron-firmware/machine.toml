# Isochron Watch Cleaner - Machine Configuration
#
# This file is embedded into the firmware at build time.
# Edit this file and rebuild to customize your machine.
#
# Pin format:
#   gpio11     - GPIO pin 11
#   !gpio12    - GPIO pin 12, active low (inverted)
#   ^gpio4     - GPIO pin 4 with pull-up resistor
#
# For SKR Pico pinout, see docs/Boards.md

[machine]
version = 1

# =============================================================================
# STEPPERS
# =============================================================================
# Motor to board connector mapping (BTT SKR Pico):
#   basket → E slot (GPIO 14, 13, 15)
#   x      → X slot (GPIO 11, 10, 12)
#   z      → Z slot (GPIO 19, 28, 2)
#   lid    → Y slot (GPIO 6, 5, 7)

# Basket motor (rotates parts in solution) - always required
# Uses E connector on BTT SKR Pico
[stepper.basket]
step_pin = "gpio14"
dir_pin = "gpio13"
enable_pin = "!gpio15"
rotation_distance = 360             # degrees per motor rotation
gear_ratio = "3:1"                  # 3:1 belt reduction
full_steps_per_rotation = 200       # 1.8 degree motor
microsteps = 16

# TMC2209 driver configuration for basket motor
[tmc2209.basket]
uart_address = 3                    # E driver is address 3
run_current = 800                   # mA
hold_current = 400                  # mA (optional, defaults to 50% of run)
stealthchop = true
stallguard_threshold = 80

# X motor (jar selection/carousel) - optional for automated machines
# Uses X connector on BTT SKR Pico
# Uncomment to enable:
#
# [stepper.x]
# step_pin = "gpio11"
# dir_pin = "gpio10"
# enable_pin = "!gpio12"
# rotation_distance = 200           # mm arc distance per motor rotation
# gear_ratio = "5:1"
# full_steps_per_rotation = 200
# microsteps = 16
# endstop_pin = "^gpio4"            # X endstop (homes to position_min)
# position_min = 0                  # mm (Klipper-style)
# position_max = 800                # mm (set based on your carousel size)
# position_endstop = 0              # mm at endstop
# homing_speed = 30                 # mm/s
#
# [tmc2209.x]
# uart_address = 0                  # X driver is address 0
# run_current = 600
# stealthchop = true
# stallguard_threshold = 60

# Z motor (raises/lowers basket) - optional for automated machines
# Uses Z connector on BTT SKR Pico
# Uncomment to enable:
#
# [stepper.z]
# step_pin = "gpio19"
# dir_pin = "gpio28"
# enable_pin = "!gpio2"
# rotation_distance = 8             # mm per leadscrew rotation
# full_steps_per_rotation = 200
# microsteps = 16
# endstop_pin = "^gpio25"           # Z endstop (homes to position_min)
# position_min = 0                  # mm (Klipper-style)
# position_max = 150                # mm max travel
# position_endstop = 0              # mm at endstop
# homing_speed = 10                 # mm/s
#
# [tmc2209.z]
# uart_address = 2                  # Z driver is address 2
# run_current = 800
# stealthchop = true
# stallguard_threshold = 60

# Lid motor (opens/closes jar lids) - optional
# Uses Y connector on BTT SKR Pico
# Uncomment to enable:
#
# [stepper.lid]
# step_pin = "gpio6"
# dir_pin = "gpio5"
# enable_pin = "!gpio7"
# rotation_distance = 360           # degrees per motor rotation
# full_steps_per_rotation = 200
# microsteps = 16
# endstop_pin = "^gpio3"            # Y endstop
#
# [tmc2209.lid]
# uart_address = 1                  # Y driver is address 1
# run_current = 400
# stealthchop = true

# =============================================================================
# HEATERS
# =============================================================================

[heater.dryer]
heater_pin = "gpio23"
sensor_pin = "gpio27"
sensor_type = "ntc100k"
control = "bang_bang"
max_temp = 55
hysteresis = 2

# Additional heater example (per-jar heating):
#
# [heater.clean_jar]
# heater_pin = "gpio21"
# sensor_pin = "gpio26"
# sensor_type = "ntc100k"
# control = "bang_bang"
# max_temp = 40
# hysteresis = 2

# =============================================================================
# JARS
# =============================================================================
# Define physical jar positions for automated machines.
# For manual machines, these define the jar sequence only.
#
# x_pos: mm from home (for x motor/jar selection)
#        For rotary carousels: arc distance from home position
#        For linear machines: linear distance from home
# z_pos: mm down from top (for z motor/lift)
# heater: optional heater name to use for this jar
# lid: optional lid motor name (multiple jars can share one motor)

[jar.clean]
x_pos = 0                 # mm (home position)
z_pos = 120
# lid = "lid"              # shared lid motor for all jars

[jar.rinse1]
x_pos = 200               # mm (arc distance for rotary, linear for straight)
z_pos = 120
# lid = "lid"

[jar.rinse2]
x_pos = 400               # mm
z_pos = 120
# lid = "lid"

[jar.dry]
x_pos = 600               # mm
z_pos = 100
heater = "dryer"
# lid = "lid_dry"          # or individual lid motor for this jar

# =============================================================================
# PROFILES
# =============================================================================
# Cleaning profiles define how the basket behaves in each jar.
#
# direction: "cw" (clockwise), "ccw" (counter-clockwise), "alternate"
# iterations: number of direction changes for alternate mode
# temperature_c: target temperature if jar has a heater

[profile.clean]
label = "Clean"
rpm = 120
time_s = 180
direction = "alternate"
iterations = 3

# Optional spin-off phase (lift basket, spin to shed excess solution)
# [profile.clean.spinoff]
# lift_mm = 20
# rpm = 150
# time_s = 10

[profile.rinse]
label = "Rinse"
rpm = 100
time_s = 120
direction = "cw"
iterations = 1

[profile.dry]
label = "Dry"
rpm = 60
time_s = 600
direction = "alternate"
iterations = 6
temperature_c = 45

# =============================================================================
# PROGRAMS
# =============================================================================
# Programs are sequences of jar/profile pairs.
# For manual machines, the display prompts user to move basket between steps.
# For automated machines, the firmware controls lift/tower motors.

[program.full_clean]
label = "Full Clean"
steps = [
    { jar = "clean", profile = "clean" },
    { jar = "rinse1", profile = "rinse" },
    { jar = "rinse2", profile = "rinse" },
    { jar = "dry", profile = "dry" },
]

[program.quick_clean]
label = "Quick Clean"
steps = [
    { jar = "clean", profile = "clean" },
    { jar = "rinse1", profile = "rinse" },
]

[program.dry_only]
label = "Dry Only"
steps = [
    { jar = "dry", profile = "dry" },
]

# =============================================================================
# DISPLAY (optional)
# =============================================================================

[display]
type = "v0_display"
uart_tx_pin = "gpio0"
uart_rx_pin = "gpio1"
baud = 115200

# =============================================================================
# ACCESSORIES (optional)
# =============================================================================

# Ultrasonic cleaner module:
# [ultrasonic.clean_jar]
# trigger_pin = "gpio16"
# power = 100

# Status LEDs:
# [neopixel.status]
# pin = "gpio24"
# count = 8

# Exhaust fan:
# [fan.exhaust]
# pin = "gpio17"
# pwm = true
